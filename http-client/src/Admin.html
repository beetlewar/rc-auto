<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="/custom_styles/slider.css">
    <link rel="stylesheet" href="/bootstrap/bootstrap.min.css">
    <script src="/bootstrap/jquery-3.3.1.min.js"></script>
    <script src="/bootstrap/popper.min.js"></script>
    <script src="/bootstrap/bootstrap.min.js"></script>
</head>

<body>
    <form>
        <div class="form-group">
            <label for="engineForwardPower">Engine forward power</label>
            <input type="range" min="0" max="100" value="40" class="slider" id="engineForwardPower" name="engineForwardPower">
        </div>
        <div class="form-group">
            <label for="engineBackwardPower">Engine backward power</label>
            <input type="range" min="0" max="100" value="20" class="slider" id="engineBackwardPower" name="engineBackwardPower">
        </div>
        <button type="submit" class="btn btn-primary" name="submit" value="apply" id="applyButton">Apply</button>
        <button type="submit" class="btn btn-primary" name="submit" value="reset" id="resetButton">Reset</button>
    </form>

    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    Loading...
                </div>
            </div>
        </div>
    </div>

    <script>
        function applyState(data) {
            console.log(data);
            $("#engineForwardPower").val(data["engineForwardPower"]);
            $("#engineBackwardPower").val(data["engineBackwardPower"]);
        };

        function beginAsync(asyncAction) {
            $('#exampleModal')
                .one('shown.bs.modal', () => {
                    console.log("begin async")
                    asyncAction(Date.now());
                })
                .modal('show');
        };

        function endAsync(apply, beginAsyncTime) {
            const modalTimeout = 1000;
            elapsed = Date.now() - beginAsyncTime;
            waitForModal = modalTimeout - elapsed;

            setTimeout(() =>
                $('#exampleModal')
                    .one('hidden.bs.modal', () => {
                        console.log("end async");
                        apply();
                    })
                    .modal('hide'),
                waitForModal);
        }

        $(document).ready(function () {
            console.log("requesting state on load");

            beginAsync(time =>
                $.get(
                    "/api/settings",
                    data => endAsync(() => applyState(data), time)))
        });

        $("#applyButton").click(function (event) {
            event.preventDefault();
            console.log("applying state");

            beginAsync(time =>
                $.post(
                    "/api/settings",
                    $("form").serialize(),
                    data => endAsync(() => { }, time)))
        });

        $("#resetButton").click(function (event) {
            event.preventDefault();
            console.log("resetting state");

            beginAsync(time =>
                $.post(
                    "/api/settings/reset",
                    $("form").serialize(),
                    data => endAsync(() => applyState(data), time)))
        });
    </script>
</body>

</html>